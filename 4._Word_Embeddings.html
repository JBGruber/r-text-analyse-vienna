<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.427">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Johannes B. Gruber">
<meta name="dcterms.date" content="2023-07-07">

<title>Workshop Automated Content Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="4._Word_Embeddings_files/libs/clipboard/clipboard.min.js"></script>
<script src="4._Word_Embeddings_files/libs/quarto-html/quarto.js"></script>
<script src="4._Word_Embeddings_files/libs/quarto-html/popper.min.js"></script>
<script src="4._Word_Embeddings_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="4._Word_Embeddings_files/libs/quarto-html/anchor.min.js"></script>
<link href="4._Word_Embeddings_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="4._Word_Embeddings_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="4._Word_Embeddings_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="4._Word_Embeddings_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="4._Word_Embeddings_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#training-our-own-embeddings" id="toc-training-our-own-embeddings" class="nav-link" data-scroll-target="#training-our-own-embeddings">Training our own embeddings</a></li>
  <li><a href="#pretrained-embeddings" id="toc-pretrained-embeddings" class="nav-link" data-scroll-target="#pretrained-embeddings">Pretrained Embeddings</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Workshop Automated Content Analysis</h1>
<p class="subtitle lead">Session 4: Word Embeddings</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Johannes B. Gruber </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 7, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<blockquote class="blockquote">
<p>You shall know a word by the company it keeps. — John Rupert Firth</p>
</blockquote>
<p>Word Embeddings are essentially a way to preprocess text. The approach takes advantage of the co-occurrences of words in the same text and constructs a representation of language by using dimension reduction techniques. If you have ever used techniques such as Principal Component Analysis, Factor Analysis, Multidimensional scaling or topic modelling, you have essentially already created embeddings. You essentially reduce the dimension of a document-feature-matrix, which can have hundreds of thousands of columns, as each one represents one specific word or feature, and turn it into a few hundred components, factors, dimension or whatever you want to call it.</p>
<p>The big advantages of word embeddings are that the reduced number of dimensions in a document-embedding-matrix are that</p>
<ul>
<li>analyses are far less expensive (however, the encoding step might be)</li>
<li>the embeddings reflect the computer’s understanding of language that it learned from the training corpus</li>
</ul>
<p>In this session we train an embedding model following the steps from <a href="https://smltar.com/embeddings.html">Supervised Machine Learning for Text Analysis in R</a>. For a long time, word embeddings performed similarly to other preprocessing steps. Sometimes it improved models, sometimes it didn’t. However, in the next session, we will learn about some newer embedding techniques that lead to a breakthrough as models could be trained on billions of text, reflecting a substantial “knowledge” gain for the models, that come as close as we’ve ever been to getting computers to understand the meaning of language. This unfortunately also means though, that large language model are a domain of the richest companies and research facilities and are not easy to create by individual researchers.</p>
</section>
<section id="training-our-own-embeddings" class="level1">
<h1>Training our own embeddings</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(widyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(irlba)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(furrr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the plenary speeches from Austria once more. I saved the tidied data, so we can skip a couple of steps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>plenary_speeches_tidy <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/plenary_speeches_tidy.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first step is to remove rare words and then nest all words in a text. Nesting means that all texts from the same group (in this case same speech) are put into a list element.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>plenary_speeches_tidy_clean <span class="ot">&lt;-</span> plenary_speeches_tidy <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_count</span>(word) <span class="sc">|&gt;</span> <span class="co"># add count</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;=</span> <span class="dv">50</span>) <span class="sc">|&gt;</span> <span class="co"># remove rare words</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>n)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>nested_words <span class="ot">&lt;-</span> plenary_speeches_tidy_clean <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">words =</span> <span class="fu">c</span>(word), <span class="at">.by =</span> speech_id)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>nested_words <span class="sc">|&gt;</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(speech_id, words) <span class="sc">|&gt;</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1000</span><span class="sc">:</span><span class="dv">1006</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  speech_id words            
      &lt;int&gt; &lt;list&gt;           
1      1001 &lt;tibble [17 × 1]&gt;
2      1002 &lt;tibble [3 × 1]&gt; 
3      1003 &lt;tibble [42 × 1]&gt;
4      1004 &lt;tibble [8 × 1]&gt; 
5      1005 &lt;tibble [57 × 1]&gt;
6      1006 &lt;tibble [3 × 1]&gt; 
7      1007 &lt;tibble [31 × 1]&gt;</code></pre>
</div>
</div>
<p>The reason for this is that in order to find the company a word keeps, we must determine where we look first. We next use a function that adds a slide window ID to the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>safe_mutate <span class="ot">&lt;-</span> <span class="fu">safely</span>(mutate)  <span class="co"># create a safe mutate function (i.e., that does not error)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#function to create sliding windows of a given size</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>slide_windows <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, window_size) {  </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use the slider package to create the windows, This creates a list with one tibble per element</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  skipgrams <span class="ot">&lt;-</span> slider<span class="sc">::</span><span class="fu">slide</span>(  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    tbl,  <span class="co"># input table</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">.f =</span> <span class="sc">~</span>.x,  <span class="co"># slide over the only column in the tbl</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.after =</span> window_size <span class="sc">-</span> <span class="dv">1</span>,  <span class="co"># inlcude the current word, plus x next words</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">.step =</span> <span class="dv">1</span>,  <span class="co"># number of words to shift forward</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.complete =</span> <span class="cn">TRUE</span>  <span class="co"># include only complete windows</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="fu">seq_along</span>(skipgrams),</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>             <span class="cf">function</span>(i) <span class="fu">safe_mutate</span>(skipgrams[[i]], <span class="at">window_id =</span> i))  <span class="co"># add the window id to the skipgrams</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># wrangle output into the right format</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  out <span class="sc">|&gt;</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transpose</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pluck</span>(<span class="st">"result"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">compact</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>()</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can test that on some toy data to see what is going on:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>toy_data <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>id, <span class="sc">~</span>text,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  1L, <span class="st">"I like cats. Cats are the best pets."</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  2L, <span class="st">"I like dogs. Dogs are the best pets."</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>toy_data <span class="sc">|&gt;</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_tokens</span>(<span class="st">"word"</span>, <span class="st">"text"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">words =</span> <span class="fu">c</span>(word), <span class="at">.by =</span> id) <span class="sc">|&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">words =</span> <span class="fu">map</span>(words, <span class="cf">function</span>(w) <span class="fu">slide_windows</span>(w, 3L))) <span class="sc">|&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(words)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 36 × 3
      id word  window_id
   &lt;int&gt; &lt;chr&gt;     &lt;int&gt;
 1     1 i             1
 2     1 like          1
 3     1 cats          1
 4     1 like          2
 5     1 cats          2
 6     1 cats          2
 7     1 cats          3
 8     1 cats          3
 9     1 are           3
10     1 cats          4
# ℹ 26 more rows</code></pre>
</div>
</div>
<p>The code makes sure that words close to each other have the same window_id and that words in different documents do not.</p>
<p>We can now calculate the Pointwise mutual information (PMI) of pairs of words. Here, PMI expresses how statistically likely it is that two words co-occur in the same document. Calculating this takes a long time. Hence I prepared this step beforehand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"data/speeches_pmi.rds"</span>)) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plan</span>(multisession)  <span class="do">## for parallel processing</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  tidy_pmi <span class="ot">&lt;-</span> nested_words <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">words =</span> <span class="fu">future_map</span>(words, <span class="cf">function</span>(w) <span class="fu">slide_windows</span>(w, 4L), <span class="at">.progress =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(words) <span class="sc">|&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unite</span>(window_id, speech_id, window_id) <span class="sc">|&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pairwise_pmi</span>(word, window_id)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(tidy_pmi, <span class="st">"data/speeches_pmi.rds"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  tidy_pmi <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/speeches_pmi.rds"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>tidy_pmi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,800,816 × 3
   item1            item2       pmi
   &lt;chr&gt;            &lt;chr&gt;     &lt;dbl&gt;
 1 damen            geehrten  3.59 
 2 herren           geehrten  3.18 
 3 gemäß            geehrten -2.82 
 4 abs              geehrten -3.37 
 5 geschäftsordnung geehrten -2.34 
 6 präsidentin      geehrten  1.76 
 7 vergangenen      geehrten -1.26 
 8 sitzung          geehrten -0.199
 9 wahl             geehrten -0.429
10 neuen            geehrten -1.68 
# ℹ 2,800,806 more rows</code></pre>
</div>
</div>
<p>To get to the embedding vectors of the words, we use singular value decomposition (SVD). SVD is a method for dimensionality reduction. In this case, we use <code>widely_svd</code>, which slightly obscures what dimensions will be reduced. Let’s make the data wide first to understand the step better:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tidy_pmi <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> item1, <span class="at">names_from =</span> item2, <span class="at">values_from =</span> pmi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,620 × 4,621
   item1     geehrten  damen  herren  gemäß     abs geschäftsordnung präsidentin
   &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;       &lt;dbl&gt;
 1 damen        3.59  NA      3.56   -2.62  -3.87             -1.38        1.42 
 2 herren       3.18   3.56  NA      -3.05  -4.30             -1.13        0.920
 3 gemäß       -2.82  -2.62  -3.05   NA      4.41              4.75       -1.48 
 4 abs         -3.37  -3.87  -4.30    4.41  NA                 4.34       -2.73 
 5 geschäft…   -2.34  -1.38  -1.13    4.75   4.34             NA          -0.405
 6 präsiden…    1.76   1.42   0.920  -1.48  -2.73             -0.405      NA    
 7 vergange…   -1.26  -0.781 -0.280  NA     -2.12             -0.403      -0.805
 8 sitzung     -0.199 -0.517 -0.0404  1.59   0.931             1.90       -2.27 
 9 wahl        -0.429 -0.824 -0.798   0.110  0.655             1.35        1.17 
10 neuen       -1.68  -1.17  -0.796  -0.484  0.0610           -2.21       -1.45 
# ℹ 4,610 more rows
# ℹ 4,613 more variables: vergangenen &lt;dbl&gt;, gesetzgebungsperiode &lt;dbl&gt;,
#   sitzung &lt;dbl&gt;, eröffnen &lt;dbl&gt;, wahl &lt;dbl&gt;, neuen &lt;dbl&gt;,
#   beziehungsweise &lt;dbl&gt;, präsidenten &lt;dbl&gt;, vorsitz &lt;dbl&gt;, führen &lt;dbl&gt;,
#   erste &lt;dbl&gt;, neu &lt;dbl&gt;, nationalrates &lt;dbl&gt;, anlässlich &lt;dbl&gt;,
#   möchte &lt;dbl&gt;, beginn &lt;dbl&gt;, erinnerung &lt;dbl&gt;, rufen &lt;dbl&gt;, bedeutung &lt;dbl&gt;,
#   wert &lt;dbl&gt;, unserer &lt;dbl&gt;, starken &lt;dbl&gt;, demokratie &lt;dbl&gt;, leben &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Essentially, we have a feature-feature-matrix, with one row and one column per feature and the PMI value of them occuring together in the cells of the matrix. SVD now reduces the dimensionality of the y-axis of the matrix, but tries to keep as much of the information as possible. The number of dimensions left are determined beforehand and we choose 100 here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tidy_word_vectors <span class="ot">&lt;-</span> tidy_pmi <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">widely_svd</span>(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">item =</span> item1, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature =</span> item2, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> pmi,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">nv =</span> <span class="dv">100</span>, </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">maxit =</span> <span class="dv">1000</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>tidy_word_vectors <span class="sc">|&gt;</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> item1, <span class="at">names_from =</span> dimension, <span class="at">values_from =</span> value)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,620 × 101
   item1        `1`     `2`      `3`      `4`     `5`      `6`      `7`      `8`
   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
 1 damen   -0.0808  -0.0496  0.0166  -0.00670 -0.0135 -0.0295   0.00177 -0.0516 
 2 herren  -0.0806  -0.0443  0.00937  0.00556 -0.0215 -0.0353   0.0244  -0.0569 
 3 gemäß    0.0125  -0.0392 -0.0397  -0.0520  -0.0452  0.00684 -0.0400  -0.0414 
 4 abs      0.00980 -0.0527 -0.0362  -0.0706  -0.0450  0.0158  -0.0599  -0.0615 
 5 geschä…  0.0104  -0.0239 -0.0306  -0.0255  -0.0141  0.00519 -0.00201 -0.0394 
 6 präsid… -0.0150  -0.0643 -0.0218  -0.0335   0.0207 -0.00776 -0.00680  0.00674
 7 vergan…  0.0177  -0.0214 -0.00993  0.00954 -0.0174  0.0239   0.0398   0.0171 
 8 sitzung  0.00621 -0.0413 -0.0407  -0.0220  -0.0287  0.0143   0.0372  -0.0302 
 9 wahl     0.0186  -0.0243 -0.0166   0.00987 -0.0169 -0.00256  0.0106  -0.0195 
10 neuen    0.00908 -0.0420  0.00974 -0.0158  -0.0163 -0.0147   0.0180   0.00822
# ℹ 4,610 more rows
# ℹ 92 more variables: `9` &lt;dbl&gt;, `10` &lt;dbl&gt;, `11` &lt;dbl&gt;, `12` &lt;dbl&gt;,
#   `13` &lt;dbl&gt;, `14` &lt;dbl&gt;, `15` &lt;dbl&gt;, `16` &lt;dbl&gt;, `17` &lt;dbl&gt;, `18` &lt;dbl&gt;,
#   `19` &lt;dbl&gt;, `20` &lt;dbl&gt;, `21` &lt;dbl&gt;, `22` &lt;dbl&gt;, `23` &lt;dbl&gt;, `24` &lt;dbl&gt;,
#   `25` &lt;dbl&gt;, `26` &lt;dbl&gt;, `27` &lt;dbl&gt;, `28` &lt;dbl&gt;, `29` &lt;dbl&gt;, `30` &lt;dbl&gt;,
#   `31` &lt;dbl&gt;, `32` &lt;dbl&gt;, `33` &lt;dbl&gt;, `34` &lt;dbl&gt;, `35` &lt;dbl&gt;, `36` &lt;dbl&gt;,
#   `37` &lt;dbl&gt;, `38` &lt;dbl&gt;, `39` &lt;dbl&gt;, `40` &lt;dbl&gt;, `41` &lt;dbl&gt;, `42` &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Every word is now expressed through the relation to all other words in the data. To find out which words are similarly used compared to word we choose, we can write a simple function that calculates the cosine similarity of rows in the matrix above and returns which rows are closest to the chosen one.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>nearest_neighbors <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, word, <span class="at">n =</span> <span class="dv">15</span>) {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  m <span class="ot">&lt;-</span> <span class="fu">cast_dfm</span>(tbl, item1, dimension, value) <span class="co"># transform to wide</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> quanteda<span class="sc">::</span><span class="fu">dfm_subset</span>(m, quanteda<span class="sc">::</span><span class="fu">docid</span>(m) <span class="sc">==</span> word) <span class="co"># extract values for the provided word</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(comp) <span class="sc">&lt;</span> 1L) <span class="fu">stop</span>(<span class="st">"word "</span>, word, <span class="st">" not found in the embedding"</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> proxyC<span class="sc">::</span><span class="fu">simil</span>(comp, m, <span class="at">method =</span> <span class="st">"cosine"</span>) <span class="co"># calculate cosine similarity</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  rank <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">as.numeric</span>(sim), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="fu">seq_len</span>(n <span class="sc">+</span> <span class="dv">1</span>)] <span class="co"># get the n highest values plus original word</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  sim[<span class="dv">1</span>, rank] <span class="sc">|&gt;</span> </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"neighbor"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check a couple of examples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nearest_neighbors</span>(tidy_word_vectors, <span class="st">"damen"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 2
   neighbor             value
   &lt;chr&gt;                &lt;dbl&gt;
 1 damen                1    
 2 herren               0.950
 3 haus                 0.408
 4 wirklich             0.326
 5 sagen                0.293
 6 zuseher              0.269
 7 frau                 0.262
 8 zuhörerinnen         0.259
 9 ausspricht           0.256
10 besucherinnen        0.256
11 regierungsmitglieder 0.246
12 eingang              0.245
13 bildschirmen         0.240
14 geehrter             0.240
15 ministerinnen        0.239
16 liebe                0.238</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nearest_neighbors</span>(tidy_word_vectors, <span class="st">"asyl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 2
   neighbor         value
   &lt;chr&gt;            &lt;dbl&gt;
 1 asyl             1    
 2 zuwanderung      0.726
 3 migration        0.669
 4 asylwerber       0.613
 5 außengrenzschutz 0.591
 6 asylverfahren    0.567
 7 illegalen        0.551
 8 außengrenzen     0.503
 9 migranten        0.493
10 asylwerbern      0.484
11 grenzschutz      0.474
12 illegale         0.468
13 flüchtlinge      0.428
14 rechtsberatung   0.411
15 rasche           0.392
16 trennung         0.382</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nearest_neighbors</span>(tidy_word_vectors, <span class="st">"russland"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 2
   neighbor    value
   &lt;chr&gt;       &lt;dbl&gt;
 1 russland    1    
 2 usa         0.700
 3 vereinigten 0.645
 4 ukraine     0.609
 5 türkei      0.606
 6 china       0.582
 7 saudi       0.510
 8 arabien     0.502
 9 osten       0.499
10 frankreich  0.481
11 beziehungen 0.473
12 ungarn      0.455
13 krieg       0.443
14 sanktionen  0.436
15 abkommen    0.436
16 jemen       0.428</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nearest_neighbors</span>(tidy_word_vectors, <span class="st">"österreich"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 2
   neighbor        value
   &lt;chr&gt;           &lt;dbl&gt;
 1 österreich      1    
 2 land            0.422
 3 menschen        0.420
 4 ganz            0.411
 5 geht            0.383
 6 weltweit        0.358
 7 dass            0.358
 8 nämlich         0.342
 9 gibt            0.333
10 wirtschaftlich  0.333
11 verhältnisse    0.328
12 schweden        0.319
13 jahren          0.316
14 internationalen 0.308
15 ja              0.304
16 prozent         0.290</code></pre>
</div>
</div>
<p>This seems to work really well, and we can think of a number of things we could do with this function:</p>
<ul>
<li>find which words are used interchangeably to reduce features with advanced pre-processing</li>
<li>create or extend a dictionary or search string using the synonyms found</li>
<li>explore which words are used very often together</li>
</ul>
<p>The embeddings also make it possible to do math with language. The iconic example is king – man + woman = queen. Let’s see if our embeddings can do a similar thing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">cast_dfm</span>(tidy_word_vectors, item1, dimension, value) <span class="co"># transform to wide</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>w1 <span class="ot">&lt;-</span> quanteda<span class="sc">::</span><span class="fu">dfm_subset</span>(m, quanteda<span class="sc">::</span><span class="fu">docid</span>(m) <span class="sc">==</span> <span class="st">"konsumenten"</span>) <span class="co"># extract values for the provided word</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>w2 <span class="ot">&lt;-</span> quanteda<span class="sc">::</span><span class="fu">dfm_subset</span>(m, quanteda<span class="sc">::</span><span class="fu">docid</span>(m) <span class="sc">==</span> <span class="st">"mann"</span>) <span class="co"># extract values for the provided word</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>comp <span class="ot">&lt;-</span> w1 <span class="sc">-</span> w2</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>sim <span class="ot">&lt;-</span> proxyC<span class="sc">::</span><span class="fu">simil</span>(comp, m, <span class="at">method =</span> <span class="st">"cosine"</span>) <span class="co"># calculate cosine similarity</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>rank <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">as.numeric</span>(sim), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="fu">seq_len</span>(<span class="dv">15</span>)] <span class="co"># get the n highest values plus original word</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>sim[<span class="dv">1</span>, rank] <span class="sc">|&gt;</span> </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"neighbor"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 2
   neighbor       value
   &lt;chr&gt;          &lt;dbl&gt;
 1 konsumenten    0.762
 2 konsumentinnen 0.651
 3 produkte       0.575
 4 lebensmittel   0.543
 5 kaufen         0.473
 6 heimische      0.469
 7 landwirte      0.434
 8 bäuerinnen     0.419
 9 produktion     0.414
10 produkt        0.409
11 versichern     0.396
12 kauf           0.378
13 produzieren    0.377
14 zugänglich     0.369
15 heimischen     0.366</code></pre>
</div>
</div>
<p>It actually works as konsumenten - mann = konsumentinnen as the second highest value.</p>
</section>
<section id="pretrained-embeddings" class="level1">
<h1>Pretrained Embeddings</h1>
<p>Pretrained embeddings contain the information learned from millions of text and make them availabe to process your data. Theoretically, this means that your analysis is supercharged as it makes use of the knowledge of language baked into the model. Let’s see how we would encode our data using the famous GloVe (Global Vectors for Word Representation) <span class="citation" data-cites="glove">(<a href="#ref-glove" role="doc-biblioref"><strong>glove?</strong></a>)</span>. We use the smallest model here trained on Wikipedia and Gigaword 5 (6B tokens, 400K unique words);</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>get_glove <span class="ot">&lt;-</span> <span class="cf">function</span>(file, <span class="at">dimensions =</span> <span class="fu">c</span>(<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>)) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># don't re-download files if present</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file)) {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    cache_loc <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">dirname</span>(file), <span class="st">"glove.6B.zip"</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(cache_loc)) {</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>      curl<span class="sc">::</span><span class="fu">curl_download</span>(<span class="st">"http://nlp.stanford.edu/data/glove.6B.zip"</span>, cache_loc, <span class="at">quiet =</span> <span class="cn">FALSE</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(cache_loc, <span class="at">files =</span> <span class="fu">basename</span>(file), <span class="at">exdir =</span> <span class="st">"data"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># read and process glove vectors</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(file, <span class="at">quote =</span> <span class="st">""</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"term"</span>, <span class="fu">paste0</span>(<span class="st">"dim"</span>, <span class="fu">seq_len</span>(<span class="fu">ncol</span>(df) <span class="sc">-</span> <span class="dv">1</span>)))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>glove_df <span class="ot">&lt;-</span> <span class="fu">get_glove</span>(<span class="st">"data/glove.6B.100d.txt"</span>, <span class="at">dimensions =</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>One problem that we still need to solve is that we get one embedding per feature, not per document. There are different strategies to embed documents instead of just words. I have been workshopping this function, which encodes a document-feature-matrix using matrix multiplication.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dfm_embed <span class="ot">&lt;-</span> <span class="cf">function</span>(dfm, embedding_vectors) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  terms <span class="ot">&lt;-</span> embedding_vectors<span class="sc">$</span>term</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  embedding_vectors<span class="sc">$</span>term <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(embedding_vectors)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(mat) <span class="ot">&lt;-</span> terms</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Some words in the dfm are not in the embedding vector. E.g.,: "</span>, </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>          <span class="fu">toString</span>(<span class="fu">colnames</span>(dfm)[<span class="sc">!</span><span class="fu">colnames</span>(dfm) <span class="sc">%in%</span> terms][<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>]))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  dfm <span class="ot">&lt;-</span> quanteda.textmodels<span class="sc">:::</span><span class="fu">force_conformance</span>(dfm, terms)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  dfm_out <span class="ot">&lt;-</span> <span class="fu">as.dfm</span>(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># matrix multiplication is used as one potential way of creating document</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># embeddings. You can also use, e.g., the average value of word embeddings</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for words per document</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    dfm <span class="sc">%*%</span> mat[<span class="fu">colnames</span>(dfm), ]</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">docvars</span>(dfm_out) <span class="ot">&lt;-</span> <span class="fu">docvars</span>(dfm)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  dfm_out</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s use the imdb dataset again and encode it using the GloVe embeddings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quanteda)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Package version: 3.3.0
Unicode version: 15.0
ICU version: 72.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Parallel computing: 12 of 12 threads used.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>See https://quanteda.io for tutorials and examples.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quanteda.textmodels)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>imdb <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/imdb.rds"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>imdb_dfm <span class="ot">&lt;-</span> imdb <span class="sc">|&gt;</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corpus</span>(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">docid_field =</span> <span class="st">"id"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">text_field =</span> <span class="st">"text"</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tokens</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">what =</span> <span class="st">"word"</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_punct =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_symbols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_numbers =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_url =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">remove_separators =</span> <span class="cn">TRUE</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tokens_replace</span>(<span class="st">"(.+)'s"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="at">valuetype =</span> <span class="st">"regex"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dfm</span>(</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">tolower =</span> <span class="cn">TRUE</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>imdb_glove <span class="ot">&lt;-</span> imdb_dfm <span class="sc">|&gt;</span> </span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dfm_embed</span>(glove_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Some words in the dfm are not in the embedding vector. E.g.,: \1, doesn't, wasn't, don't, we're, aren't, i'll, i'm, cringe-worthy, fire-which, didn't, alone-oblivious, barely-tapped, who've, i've, could'nt, cliché'e, did'nt, they're, mop-top</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 56518 features in newdata not used in prediction.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>imdb_glove</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Document-feature matrix of: 50,000 documents, 100 features (0.00% sparse) and 1 docvar.
    features
docs       dim1      dim2      dim3       dim4        dim5      dim6       dim7
   1  -8.198567  36.86236  76.26090  -46.95107 -16.8182190  33.93069  -25.74015
   2  -8.193000  19.10797  47.35466  -32.52341  -4.9645700  34.17864  -20.19262
   3 -50.041062 133.17060 337.46812 -231.60812  -3.8266829 196.96682 -103.66397
   4  -7.392893  40.67658  78.91681  -49.87687 -21.2045716  36.33516  -35.14699
   5 -19.630636  55.74541 131.79581  -84.29255  -5.4515802  72.16361  -45.47628
   6 -13.069173  41.04628  85.66440  -54.74339   0.1096727  35.09399  -29.94660
    features
docs      dim8       dim9       dim10
   1  27.78858 -10.220836 -13.9339519
   2  12.96687 -15.819574   3.9014659
   3 154.72404 -91.415527 -10.9809287
   4  22.61649  -8.303111  -5.9752606
   5  44.39549 -46.004176  14.4419319
   6  42.41228 -22.263890  -0.5194892
[ reached max_ndoc ... 49,994 more documents, reached max_nfeat ... 90 more features ]</code></pre>
</div>
</div>
<p>Instead of showing the features in the columns, the matrix multiplication combines the embeddings of each word in the dfm (and how often it is used!) into one vector (i.e., row in the data.frame).</p>
<p>We can try again to find the nearest_neighbors. But this time, we will compare documents;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>nearest_neighbors2 <span class="ot">&lt;-</span> <span class="cf">function</span>(m, word, <span class="at">n =</span> <span class="dv">15</span>) {</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>quanteda<span class="sc">::</span><span class="fu">is.dfm</span>(m)) {</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">cast_dfm</span>(tbl, item1, dimension, value) <span class="co"># transform to wide</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  comp <span class="ot">&lt;-</span> quanteda<span class="sc">::</span><span class="fu">dfm_subset</span>(m, quanteda<span class="sc">::</span><span class="fu">docid</span>(m) <span class="sc">==</span> word) <span class="co"># extract values for the provided word</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  sim <span class="ot">&lt;-</span> proxyC<span class="sc">::</span><span class="fu">simil</span>(comp, m, <span class="at">method =</span> <span class="st">"cosine"</span>) <span class="co"># calculate cosine similarity</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  rank <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">as.numeric</span>(sim), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="fu">seq_len</span>(n <span class="sc">+</span> <span class="dv">1</span>)] <span class="co"># get the n highest values plus original word</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  sim[<span class="dv">1</span>, rank] <span class="sc">|&gt;</span> </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"neighbor"</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nearest_neighbors2</span>(imdb_glove, <span class="st">"1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 2
   neighbor value
   &lt;chr&gt;    &lt;dbl&gt;
 1 1        1    
 2 9764     0.997
 3 6248     0.997
 4 37774    0.996
 5 1141     0.996
 6 33300    0.996
 7 3747     0.996
 8 45409    0.996
 9 27072    0.996
10 15190    0.996
11 35833    0.996
12 34148    0.996
13 45196    0.996
14 35306    0.996
15 45188    0.996
16 46766    0.996</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>imdb<span class="sc">$</span>text[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Once again Mr. Costner has dragged out a movie for far longer than necessary. Aside from the terrific sea rescue sequences, of which there are very few I just did not care about any of the characters. Most of us have ghosts in the closet, and Costner's character are realized early on, and then forgotten until much later, by which time I did not care. The character we should really care about is a very cocky, overconfident Ashton Kutcher. The problem is he comes off as kid who thinks he's better than anyone else around him and shows no signs of a cluttered closet. His only obstacle appears to be winning over Costner. Finally when we are well past the half way point of this stinker, Costner tells us all about Kutcher's ghosts. We are told why Kutcher is driven to be the best with no prior inkling or foreshadowing. No magic here, it was all I could do to keep from turning it off an hour in."</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>imdb<span class="sc">$</span>text[<span class="dv">4269</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Where should I begin with this movie. All I know is that it is a mess. Be the script, story, or the actors. First of all, this movie is very disappointing from Salman Khan who gave us a fun Dulhan Hum Le Jayenge and Har Dil Jo Pyar Karega before this. Second Rani is getting really annoying, appearing in every stupid movie since Kuch Kuch Hota Hai (glad Saathiya stopped this nonsense). The story is stolen from The Wedding Singer, but ruins the funny movie. The dialogues are lacking. I may have laughed here and there, but entertained? NO!!! Salman Khan was tolerable in the above mentioned movies, but here he is insane. His character is poorly written. One minute he is poor and next minute you wonder how is he poor. Rani Mukherjee looks like a plain jain and wasn't putting any effort. She luckily redeemed her career with Saathiya because her career was going haywire around this time. Pooja Batra put a little charm here with her looks but it is still not enough. Jackie Shroff is wasted. Kashmira Shah's beauty and acting has ran away from her because she chose such a horrible script. Raveena Tandon looks beautiful, but puts little performance. Mohnish Behl gets the award for Worst (Supporting) Actor (they need Razzie's because there have been terrible movies in India). He says stupid dialogues, dances terribly, looks weird, and is not in his regular form. Just to tell you, there is more to the cast who are also terrible. If it weren't for Raveena's awesome beauty in Aa Meri Life Bana De, I wouldn't give the movie a point. Otherwise the dancing by Salman was terrible. Pooja Batra was dancing like a wind in Savariya, otherwise I wish the costumes were given a make-over and the rest of the cast (and their monkey dancing) had been blown away from the wind. The good song of the album was O Priya O Priya which doesn't have a good enough picturization. Same goes for the half way decent title song. Otherwise this movie (and the rest of the songs) are a no-no for everyone."</code></pre>
</div>
</div>
<p>I tried a few combinations, but this does not really seem to work.</p>
<p>Instead, let’s try to use the document-embeddings-matrix for machine learning. First we divide the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>test_ids <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">docnames</span>(imdb_glove), <span class="at">size =</span> <span class="fu">length</span>(<span class="fu">docnames</span>(imdb_glove)) <span class="sc">*</span> <span class="fl">0.15</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>training_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_subset</span>(imdb_glove, <span class="sc">!</span><span class="fu">docnames</span>(imdb_glove) <span class="sc">%in%</span> test_ids)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>test_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_subset</span>(imdb_glove, <span class="fu">docnames</span>(imdb_glove) <span class="sc">%in%</span> test_ids)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we use the SVM implementation in <code>quanteda.texmodels</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>model_nb <span class="ot">&lt;-</span> <span class="fu">textmodel_svmlin</span>(training_dfm, <span class="at">y =</span> <span class="fu">docvars</span>(training_dfm, <span class="st">"label"</span>))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>predicted_class <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_nb, <span class="at">newdata =</span> test_dfm)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">confusionMatrix</span>(<span class="fu">table</span>(<span class="fu">docvars</span>(test_dfm, <span class="st">"label"</span>), predicted_class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Confusion Matrix and Statistics

     predicted_class
       neg  pos
  neg    2 3736
  pos    4 3758
                                        
               Accuracy : 0.5013        
                 95% CI : (0.49, 0.5127)
    No Information Rate : 0.9992        
    P-Value [Acc &gt; NIR] : 1             
                                        
                  Kappa : -5e-04        
                                        
 Mcnemar's Test P-Value : &lt;2e-16        
                                        
            Sensitivity : 0.3333333     
            Specificity : 0.5014678     
         Pos Pred Value : 0.0005350     
         Neg Pred Value : 0.9989367     
             Prevalence : 0.0008000     
         Detection Rate : 0.0002667     
   Detection Prevalence : 0.4984000     
      Balanced Accuracy : 0.4174006     
                                        
       'Positive' Class : neg           
                                        </code></pre>
</div>
</div>
<p>This is a little underwhelming, but also not totally surprising. The problem is the error message that a lot of features were dropped. Only the features that are also in GloVe embeddings could be taken into account. Roughly half of all words were removed.</p>
<p>We can also see how this would look like in tidymodels, since the embedding step is already implemented and has been properly tested there. For some reason, however, their <code>step_word_embeddings</code> is using a lot more memory, which is why I sample the data down to make it possible to run this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(textrecipes)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>imdb_sample <span class="ot">&lt;-</span> imdb <span class="sc">|&gt;</span> </span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_frac</span>(<span class="at">size =</span> <span class="fl">0.05</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>imdb_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(label <span class="sc">~</span> text, <span class="at">data =</span> imdb_sample) <span class="sc">%&gt;%</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(text, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">strip_punct =</span> <span class="cn">FALSE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_word_embeddings</span>(text, <span class="at">embeddings =</span> <span class="fu">as_tibble</span>(glove_df), <span class="at">aggregation =</span>  <span class="st">"mean"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As before, we split the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> imdb_sample, </span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">prop =</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">4</span>,   <span class="co"># the prop is the default, I just wanted to make that visible</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">strata =</span> label  <span class="co"># this makes sure the prevalence of labels is still the same afterwards</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>imdb_train <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>imdb_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s bake the recipe and see how the embeddings look like that are created here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>imdb_rec <span class="sc">%&gt;%</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(<span class="fu">head</span>(imdb)) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 101
  label wordembed_text_dim1 wordembed_text_dim2 wordembed_text_dim3
  &lt;fct&gt;               &lt;dbl&gt;               &lt;dbl&gt;               &lt;dbl&gt;
1 neg               -0.0679               0.218               0.467
2 neg               -0.0948               0.170               0.423
3 neg               -0.113                0.178               0.384
4 neg               -0.0576               0.221               0.419
5 neg               -0.118                0.193               0.408
6 neg               -0.127                0.217               0.405
# ℹ 97 more variables: wordembed_text_dim4 &lt;dbl&gt;, wordembed_text_dim5 &lt;dbl&gt;,
#   wordembed_text_dim6 &lt;dbl&gt;, wordembed_text_dim7 &lt;dbl&gt;,
#   wordembed_text_dim8 &lt;dbl&gt;, wordembed_text_dim9 &lt;dbl&gt;,
#   wordembed_text_dim10 &lt;dbl&gt;, wordembed_text_dim11 &lt;dbl&gt;,
#   wordembed_text_dim12 &lt;dbl&gt;, wordembed_text_dim13 &lt;dbl&gt;,
#   wordembed_text_dim14 &lt;dbl&gt;, wordembed_text_dim15 &lt;dbl&gt;,
#   wordembed_text_dim16 &lt;dbl&gt;, wordembed_text_dim17 &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>They look very similar. But since we are taking the average here rather than multiplying the matrix, the values appear much smaller.</p>
<p>So let’s continue and add the algorithm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(discrim)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'discrim'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dials':

    smoothness</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>nb_spec <span class="ot">&lt;-</span> <span class="fu">naive_Bayes</span>() <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"naivebayes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Create our workflow:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>imdb_wf_nb <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(imdb_rec) <span class="sc">%&gt;%</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(nb_spec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>model_nb <span class="ot">&lt;-</span> <span class="fu">fit</span>(imdb_wf_nb, <span class="at">data =</span> imdb_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s predict the classes of the held out sample and compare it to the real ones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>imdb_prediction <span class="ot">&lt;-</span> imdb_test <span class="sc">%&gt;%</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(model_nb, <span class="at">new_data =</span> imdb_test)) <span class="sc">%&gt;%</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">truth =</span> label, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat</span>(imdb_prediction, truth, estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction neg pos
       neg 227 113
       pos  96 190</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>my_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(accuracy, kap, precision, recall, f_meas)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">my_metrics</span>(imdb_prediction, <span class="at">truth =</span> truth, <span class="at">estimate =</span> estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data_color</span>(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">columns =</span> .estimate,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">fn =</span> scales<span class="sc">::</span><span class="fu">col_numeric</span>(</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"orange"</span>, <span class="st">"green"</span>),</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">domain =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div id="chmxjmuoty" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#chmxjmuoty table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#chmxjmuoty thead, #chmxjmuoty tbody, #chmxjmuoty tfoot, #chmxjmuoty tr, #chmxjmuoty td, #chmxjmuoty th {
  border-style: none;
}

#chmxjmuoty p {
  margin: 0;
  padding: 0;
}

#chmxjmuoty .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#chmxjmuoty .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#chmxjmuoty .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#chmxjmuoty .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#chmxjmuoty .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#chmxjmuoty .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#chmxjmuoty .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#chmxjmuoty .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#chmxjmuoty .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#chmxjmuoty .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#chmxjmuoty .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#chmxjmuoty .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#chmxjmuoty .gt_spanner_row {
  border-bottom-style: hidden;
}

#chmxjmuoty .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#chmxjmuoty .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#chmxjmuoty .gt_from_md > :first-child {
  margin-top: 0;
}

#chmxjmuoty .gt_from_md > :last-child {
  margin-bottom: 0;
}

#chmxjmuoty .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#chmxjmuoty .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#chmxjmuoty .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#chmxjmuoty .gt_row_group_first td {
  border-top-width: 2px;
}

#chmxjmuoty .gt_row_group_first th {
  border-top-width: 2px;
}

#chmxjmuoty .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#chmxjmuoty .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#chmxjmuoty .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#chmxjmuoty .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#chmxjmuoty .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#chmxjmuoty .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#chmxjmuoty .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#chmxjmuoty .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#chmxjmuoty .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#chmxjmuoty .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#chmxjmuoty .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#chmxjmuoty .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#chmxjmuoty .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#chmxjmuoty .gt_left {
  text-align: left;
}

#chmxjmuoty .gt_center {
  text-align: center;
}

#chmxjmuoty .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#chmxjmuoty .gt_font_normal {
  font-weight: normal;
}

#chmxjmuoty .gt_font_bold {
  font-weight: bold;
}

#chmxjmuoty .gt_font_italic {
  font-style: italic;
}

#chmxjmuoty .gt_super {
  font-size: 65%;
}

#chmxjmuoty .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#chmxjmuoty .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#chmxjmuoty .gt_indent_1 {
  text-indent: 5px;
}

#chmxjmuoty .gt_indent_2 {
  text-indent: 10px;
}

#chmxjmuoty .gt_indent_3 {
  text-indent: 15px;
}

#chmxjmuoty .gt_indent_4 {
  text-indent: 20px;
}

#chmxjmuoty .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=".metric">.metric</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id=".estimator">.estimator</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id=".estimate">.estimate</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers=".metric" class="gt_row gt_left">accuracy</td>
<td headers=".estimator" class="gt_row gt_left">binary</td>
<td headers=".estimate" class="gt_row gt_right" style="background-color: #D4C800; color: #000000;">0.6661342</td></tr>
    <tr><td headers=".metric" class="gt_row gt_left">kap</td>
<td headers=".estimator" class="gt_row gt_left">binary</td>
<td headers=".estimate" class="gt_row gt_right" style="background-color: #FF8100; color: #000000;">0.3304230</td></tr>
    <tr><td headers=".metric" class="gt_row gt_left">precision</td>
<td headers=".estimator" class="gt_row gt_left">binary</td>
<td headers=".estimate" class="gt_row gt_right" style="background-color: #D4C800; color: #000000;">0.6676471</td></tr>
    <tr><td headers=".metric" class="gt_row gt_left">recall</td>
<td headers=".estimator" class="gt_row gt_left">binary</td>
<td headers=".estimate" class="gt_row gt_right" style="background-color: #C9CF00; color: #000000;">0.7027864</td></tr>
    <tr><td headers=".metric" class="gt_row gt_left">f_meas</td>
<td headers=".estimator" class="gt_row gt_left">binary</td>
<td headers=".estimate" class="gt_row gt_right" style="background-color: #CFCB00; color: #000000;">0.6847662</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>This interestingly worked a lot better than my own function and quanteda. But still a lot worse than what we did in the previous session! We could probably improve this by using the larger GloVe model and fitting the model on the full data. But I could no longer load this into memory then!</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>